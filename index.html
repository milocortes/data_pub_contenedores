<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tutorial. Apptainer - Apptainer. Data Pub</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="apptainer.html" class="active"><strong aria-hidden="true">1.</strong> Tutorial. Apptainer</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Apptainer. Data Pub</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="apptainer"><a class="header" href="#apptainer">Apptainer</a></h1>
<p><a href="https://apptainer.org/">Apptainer</a> es una tecnología de contenedores que simplifica la creación y ejecución de contenedores. Apptainer representa una alternativa a Docker en cómputo cientíico.</p>
<p>La instalación de Apptainer puede encontrarse en la siguiente URL:</p>
<ul>
<li><a href="https://apptainer.org/docs/admin/main/installation.html">https://apptainer.org/docs/admin/main/installation.html</a></li>
</ul>
<h2 id="descarga-e-interacción-de-imágenes-pre-construidas"><a class="header" href="#descarga-e-interacción-de-imágenes-pre-construidas">Descarga e interacción de imágenes pre-construidas</a></h2>
<p>Podemos usar los comandos <code>pull</code> y <code>build</code> para descargar imágenes de algún recurso externo como un registro OCI (Oracle Cloud Infrastructure).</p>
<p>Podemos descargar imágenes preconstruidas de repositorios como:</p>
<ul>
<li>https://hub.docker.com</li>
<li>https://quay.io</li>
</ul>
<blockquote>
<p>Ejemplo de descarga de Docker Hub : <code>apptainer pull docker://alpine</code></p>
</blockquote>
<blockquote>
<p>Ejemplo de descarga de Quay: <code>apptainer pull docker://quay.io/jitesoft/alpine</code></p>
</blockquote>
<p>También podemos usar el comando <code>build</code> para descargar imágenes de un recurso externo. Cuando se usa <code>build</code> se debe especificar el nombre del contenedor:</p>
<pre><code class="language-bash">apptainer build alpine.sif docker://alpine
</code></pre>
<h2 id="interacción-con-las-imágenes"><a class="header" href="#interacción-con-las-imágenes">Interacción con las imágenes</a></h2>
<p>Hagamos pull a la imagen <code>lolcow_latest.sif</code> de ghcr.io:</p>
<pre><code class="language-bash">apptainer pull docker://ghcr.io/apptainer/lolcow
</code></pre>
<h3 id="shell"><a class="header" href="#shell">Shell</a></h3>
<p>El comando <code>shell</code> permite generar un nuevo shell dentro del contenedor e interactuar con él como si fuera una máquina virtual.</p>
<pre><code class="language-bash">$ apptainer shell lolcow_latest.sif
</code></pre>
<p>Dentro del contenedor de Apptainer, se mantiene el mismo usuario que el del host:</p>
<pre><code class="language-bash">Apptainer&gt; whoami
milo
Apptainer&gt; id
uid=1000(milo) gid=1000(milo) groups=1000(milo),65534(nogroup)
</code></pre>
<blockquote>
<p>Se agrega <code>Apptainer&gt;</code> al inicio del shell hace explícito que estamos en un nuevo shell dentro del contenedor.</p>
</blockquote>
<p>Podemos agregar una bandera a la instrucción <code>apptainer shell</code> con un nuevo PID.</p>
<h3 id="comando-exec"><a class="header" href="#comando-exec">Comando <code>exec</code></a></h3>
<p>El comando <code>exec</code> nos permite ejecutar un comando dentro de un contenedor especificando el archivo <code>.sif</code>. Por ejemplo, para ejecutar el programa <code>cowsay</code> dentro del contenedor <code>lolcow_latest.sif</code>:</p>
<pre><code class="language-bash">$ apptainer exec lolcow_latest.sif cowsay &quot;Bienvenidos al Data Pub de Mayo!!&quot;
</code></pre>
<h3 id="comando-run"><a class="header" href="#comando-run">Comando <code>run</code></a></h3>
<p>Los contenedores de Apptainer pueden contener runscripts. Estos son programas definidos por el usuario donde se especifica las acciones que el contenedor debe llevar acabo cuando se ejecuta. </p>
<p>El runscript se puede activar con el comando <code>run</code>  o invocando al contenedor como si fuera un ejecutable.</p>
<pre><code class="language-bash">$ apptainer run lolcow_latest.sif
______________________________
&lt; Mon Aug 16 13:01:55 CDT 2021 &gt;
 ------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||

$ ./lolcow_latest.sif
______________________________
&lt; Mon Aug 16 13:12:50 CDT 2021 &gt;
 ------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre>
<h3 id="trabajando-con-archivos"><a class="header" href="#trabajando-con-archivos">Trabajando con archivos</a></h3>
<p>Archivos en el host son alcanzables desde dentro del contenedor:</p>
<pre><code class="language-bash">$ echo &quot;Hola dentro del Contenedor, Parroquian@s!&quot; &gt; $HOME/hostfile.txt

$ apptainer exec lolcow_latest.sif cat $HOME/hostfile.txt

Hola dentro del Contenedor, Parroquian@s!
</code></pre>
<p>El ejemplo funciona porque el archivo <code>hostfile.txt</code> existe en el directorio home del usuario (<code>$HOME</code>). Por default, Apptainer monta el directorio <code>$HOME</code>, el directorio de trabajo actual, así como ubicaciones adicionales del sistema del host en el contenedor. </p>
<p>Es posible montar directorios adicionales en el contenedor con la opción <code>--bind</code>. En el siguiente ejemplo montamos el directorio <code>/data</code> del host en el directorio  <code>/mnt</code> dentro del contenedor.</p>
<pre><code class="language-bash">$ echo &quot;Drink milk (and never eat hamburgers).&quot; &gt; /data/cow_advice.txt

$ apptainer exec --bind /data:/mnt lolcow_latest.sif cat /mnt/cow_advice.txt
Drink milk (and never eat hamburgers).
</code></pre>
<p>Pipes y redireccionamientos también funcionan con los comandos de Apptainer, exactamente igual que con los comandos de Linux:</p>
<pre><code class="language-bash">$ cat /data/cow_advice.txt | apptainer exec lolcow_latest.sif cowsay
 ________________________________________
&lt; Drink milk (and never eat hamburgers). &gt;
 ----------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre>
<h3 id="configuración-de-imagen-mediante-un-sandbox"><a class="header" href="#configuración-de-imagen-mediante-un-sandbox">Configuración de imagen mediante un sandbox</a></h3>
<p>Un <code>sandbox</code> es un contenedor dentro de un directorio. </p>
<blockquote>
<p>Un sandbox es un entorno aislado de pruebas.</p>
</blockquote>
<p>Los pasos para configurar una imagen mediante un <code>sandbox</code> son los siguientes:</p>
<ul>
<li>
<ol>
<li>Construir la imagen como <code>sandbox</code> :</li>
</ol>
</li>
</ul>
<pre><code class="language-bash">apptainer build --sandbox &lt;DIR&gt; | &lt;imagen&gt;
</code></pre>
<ul>
<li>
<ol start="2">
<li>Solicitar un shell en el directorio del <code>sandbox</code>:</li>
</ol>
</li>
</ul>
<pre><code class="language-bash">apptainer shell --writable &lt;DIR&gt;
</code></pre>
<ul>
<li>
<ol start="3">
<li>Realizar la configuración requerida.</li>
</ol>
</li>
<li>
<ol start="4">
<li>Convertir el sandbox a formato SIF:</li>
</ol>
</li>
</ul>
<pre><code class="language-bash">apptainer build imagen.sif &lt;DIR&gt;
</code></pre>
<p>La siguiente instrucción construye un sandbox a partir de una imagen de Ubuntu de Docker</p>
<pre><code class="language-bash">$ apptainer build --sandbox ubuntu/ docker://ubuntu
</code></pre>
<p>El comando crea un directorio llamado <code>ubuntu/</code> con un Sistema Operativo completo de Ubuntu y algunos metadatos de Apptainer en el directorio de trabajo actual.</p>
<p>Es posible utilizar comandos como <code>shell</code>, <code>exec</code> y <code>run</code> con este directorio sandbox tan cual como lo haríamos con una imagen .sif de Apptainer. Si agregamos la opción <code>--writable</code> o <code>-w</code> al utilizar el contenedor, podemos escribir archivos dentro del directorio sandbox (siempre y cuando se cuente con los permisos para hacerlo).</p>
<blockquote>
<p>Si agregamos las opciones <code>-pf</code>, significa que ejecutamos el contenedor en un nuevo PID (<code>--pid</code>) así como tambien con la apariencia de ejecutarse como root(<code>--fakeroot</code>) </p>
</blockquote>
<pre><code class="language-bash">$ apptainer exec --writable ubuntu touch /foo

$ apptainer exec ubuntu/ ls /foo
/foo
</code></pre>
<h3 id="convertir-imágenes-de-un-formato-a-otro"><a class="header" href="#convertir-imágenes-de-un-formato-a-otro">Convertir imágenes de un formato a otro</a></h3>
<p>El comando <code>build</code> nos permite construir un nuevo contenedor a partir de un contenedor existente. Por ejemplo, si tienes configurado un directorio sandbox y quieres convertirlo a .sif ( Singularity Image Format), puedes ejecutar la instrucción:</p>
<pre><code class="language-bash">$ apptainer build new.sif sandbox
</code></pre>
<h3 id="archivos-de-definición-de-apptainer"><a class="header" href="#archivos-de-definición-de-apptainer">Archivos de definición de Apptainer</a></h3>
<p>Para construir un contenedor reproducible, verificable y con calidad de producción, se recomienda crear un archivo SIF utilizando un archivo de definición de Apptainer. Además, facilita la adición de archivos, variables de entorno e instalación de software personalizado. Es posible comenzar con imágenes base de Docker Hub y usar imágenes directamente de repositorios oficiales como Ubuntu, Debian, CentOS, Arch y BusyBox.</p>
<p>Un archivo de definición tiene un encabezado y un cuerpo. El encabezado determina el contenedor base de inicio. El cuerpo está dividido en secciones que realizan tareas como instalación de software, configuración del ambiente, copiado de archivos del host al contenedor, etc. </p>
<p>El siguiente es un ejemplo de un archivo de definición:</p>
<pre><code class="language-bash">BootStrap: docker
From: ubuntu:22.04

%post
   apt-get -y update
   apt-get -y install cowsay lolcat

%environment
   export LC_ALL=C
   export PATH=/usr/games:$PATH

%runscript
   date | cowsay | lolcat

%labels
   Author Alice
</code></pre>
<p>Asumiendo que el archivo de configuración toma el nombre de <code>lolcow.def</code>, podemos construir el contenedor con la instrucción <code>build</code>:</p>
<pre><code class="language-bash">$ apptainer build lolcow.sif lolcow.def
</code></pre>
<p>En este caso, el encabezado indica a Apptainer que utilice como imagen base un Ubuntu 22.04 de Docker Hub.</p>
<p>Las secciones definidas en el archivo ejecutan las siguientes tareas:</p>
<ul>
<li><code>%post</code>: esta sección es ejecutada dentro del contenedor durante la construcción del mismo, después que el Sistema Operativo base ha sido instalado. Esta sección es el lugar para realizar instalaciones de nuevas bibliotecas y aplicaciones.</li>
<li><code>%environment</code> : define variables de entorno que estarán disponibles para el contenedor en tiempo de ejecución.</li>
<li><code>%runscript</code> : La sección define las acciones que debe realizar el contenedor cuando es ejecutado con la instrucción <code>run</code>. (Estos comandos no se ejecutarán en el momento de la construcción del contenedor).</li>
<li><code>%labels</code>: La sección permite agregar metadatos personalizados al contenedor.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
